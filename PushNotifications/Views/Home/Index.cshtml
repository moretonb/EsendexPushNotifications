@{
    ViewBag.Title = "Home Page";
}

<div class="jumbotron">
    <h1>Some Notification Application</h1>
</div>

<div id="body">
    <section class="content-wrapper main-content clear-fix">
        <h2>Inbound Messages</h2>
        <ul data-bind="foreach: inboundMessages">
            <li>
                From: <strong data-bind="text: from"></strong><br />
                To: <strong data-bind="text: to"></strong><br />
                Message: <strong data-bind="text: text"></strong><br />
                AccountId: <strong data-bind="text: accountId"></strong>
            </li>
        </ul>
        <h2>Delivered Messages</h2>
        <ul data-bind="foreach: deliveredMessages">
            <li>
                OccurredAt:<strong data-bind="text: occurredAt"></strong><br />
                MessageId:<strong data-bind="text: messageId"></strong><br />
                AccountId:<strong data-bind="text: accountId"></strong>
            </li>
        </ul>
    </section>
</div>

@Scripts.Render("~/bundles/jquery")

<script src="@Url.Content("~/Scripts/knockout-3.1.0.js")" type="text/javascript"></script>

<script>
    function InboundMessage(from, to, text, accountId) {
        var self = this;
        self.from = from;
        self.to = to;
        self.text = text;
        self.accountId = accountId;
    }

    function DeliveredMessage(occurredAt, messageId, accountId) {
        var self = this;
        self.occurredAt = occurredAt;
        self.messageId = messageId;
        self.accountId = accountId;
    }

    function AppViewModel() {
        var self = this;
        self.inboundMessages = ko.observableArray([]);
        self.addInboundMessage = function (m) {
            var message = new InboundMessage(m.From, m.To, m.MessageText, m.AccountId);
            self.inboundMessages.push(message);
        }

        self.deliveredMessages = ko.observableArray([]);
        self.addDeliveredMessage = function (m) {
            var message = new DeliveredMessage(m.OccurredAt, m.MessageId, m.AccountId);
            self.deliveredMessages.push(message);
        }
    }

    $(document).ready(function () {
        var viewModel = new AppViewModel();
        ko.applyBindings(viewModel);

        if (!!window.EventSource) {
            var inboundSource = new EventSource('/api/inboundmessages/');
            inboundSource.addEventListener('message', function (e) {
                var json = JSON.parse(e.data);
                viewModel.addInboundMessage(json);
            }, false);

            var deliveredSource = new EventSource('/api/deliveredmessages/');
            deliveredSource.addEventListener('message', function (e) {
                var json = JSON.parse(e.data);
                console.log(JSON.stringify(json));
                viewModel.addDeliveredMessage(json);
            }, false);
        } else {
            // not supported!
            //fallback to something else
        }
    });
</script>